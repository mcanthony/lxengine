<!DOCTYPE html>
<html>
    <head>
      <title>Patterns</title>
      <link type="text/css" href="../shared/style/default.less" rel="stylesheet/less" />
      <link type="text/css" href="style.less" rel="stylesheet/less" />

      <script src="http://yandex.st/highlightjs/6.1/highlight.min.js"></script>
      <link rel="stylesheet" href="http://yandex.st/highlightjs/6.1/styles/github.css">
      
      <script type="text/javascript" src="../shared/script/extern/less-1.1.3.min.js"></script>
      <script type="text/javascript" src="../shared/script/extern/jquery-1.6.4.min.js"></script>
      <script type="text/javascript" src="../shared/script/extern/jquery.cookie.js"></script>
      <script type="text/javascript">
      <!--
        var scriptFiles = [ 
          "../shared/script/lx.core-0.1.1.js",
          "../shared/script/lx.vec.js",
          "../shared/script/lx.webUtil-0.1.0.js",
          "../shared/script/jquery.lx.seamlessImage-current.js",
          "../lxlang/lxlang.js",
        ];
        for (var i in scriptFiles) {
          var s = "<script type='text/javascript' src='";
          s += scriptFiles[i] + "?rand=" + Math.random();
          s += "'></script>";
          document.writeln(s);
        }
      -->
      </script>

    </head>
    <body>
       <div id="body-wrap1">
        <h1>Patterns</h1>

        <h2>About</h2>
        <div class="layout-row">
          <div style="max-width: 40em">
            <p>
                <strong>Project Status:</strong>&nbsp;&nbsp;
                <span style="font-size: 80%; color: #CCC">
                    <span style="color: #37A; font-weight: bold; text-shadow: #DDD 0px 0px 2px">Prototype</span> |
                    Development |
                    Alpha |
                    Beta |
                    Production 
                </span>
            </p>
            
            <p>
                A collection of pattern functions primarily designed for creating procedurals with the ShaderBuilder.
            </p>
            <p>
              The functions for generating the patterns are available for download below, or the click on the image
              examples to download a static image version of the pattern.
            </p>
            

            <table class="clean-table">
                <tr>
                    <td>LxLang Source</td>
                    <td><a href="../shared/script/lx.patterns.lxlang">lx.patterns.lxlang</a></td>
                </tr>
                <tr>
                    <td>Compiled Javascript</td>
                    <td>
                        <a id="compiled-link" href="#" target="_blank">lx.patterns.js</a><strong>*</strong> | 
                        (<a href="../shared/script/lx.patterns-0.1.0.js" target="_blank">0.1.0</a>)
                    </td>
                </tr>
                <tr>
                    <td>Unoptimized Javascript</td>
                    <td><a id="download-link" href="#" target="_blank">lx.patterns.js</a></td>
                </tr>
            </table>

            <p style="font-style: italic; font-size: 9pt">
                <strong>*</strong> This links to the dynamically generated Javascript after it has been
                run through the <a href="http://code.google.com/closure/compiler/docs/gettingstarted_api.html">Google Closure Compiler</a>.
                Currently, the generated Javascript code has a dependency on <a href="../shared/script/lx.vec.js">lx.vec.js</a>.
            </p>
            
            <h4>Implementation</h4>
            <p>
              The patterns below are all dynamically generated with multi-sampling. The pattern images then use
              the <a href="../seamlessImage">JQuery seamless image plug-in</a> to animate and allow user control over 
              zooming in and out on the pattern.
            </p>
            <h4>LxLang</h4>
            <p>
              <strong>Work in progress:</strong> the source code for the pattern functions themselves is being
              converted from pure Javascript to <a href="../lxlang">LxLang</a> generated Javascript (since LxLang
              allows for a more GLSL-like syntax including overloaded operators and functions).  Since it is a work
              in progress, this page currently displays a mix of Javascript and LxLang code as the source
              for each pattern function.
            </p>

          </div>
            <div>
                <div style="border: 1px solid #CCC; border-radius: 6px; padding: 8px 2em 8px 8px;  width: 12em; margin-left: 2em">
                    <strong style="color: #777">Table of Contents</strong>
                    <div id="toc"></div>
                </div>
            </div>  
        </div>

        <h2>Settings</h2>

        <table class="clean-table">
          <tr>
            <td>Color scheme</td>
            <td>
              <select id="colorScheme">
                  <option selected value="[0,0,0]|[255,255,255]">black &amp; white</option>
                  <option value="[255,255,255]|[0,0,0]">white &amp; black</option>
                  <option value="[206,40,40]|[249,217,95]">red &amp; gold</option>
                  <option value="[13,50,55]|[45,176,59]">blue &amp; green</option>
              </select>
            </td>
          </tr>
          
          <tr>
            <td>Resolution</td>
            <td>
              <select id="resolution">
                <option selected value="512,512">512 x 512</option>
                <option selected value="256,256">256 x 256</option>
                <option value="128,128">128 x 128</option>
                <option value="64,64">64 x 64</option>
                <option value="32,32">32 x 32</option>
                <option value="16,16">16 x 16</option>
                <option value="8,8">8 x 8</option>
                <option value="4,4">4 x 4</option>
            </select>
            </td>
          </tr>

          <tr>
            <td>Multi-sample</td>
            <td>
              <select id="Select1">
                <option selected value="true">yes</option>
                <option value="false">no</option>
            </select>
            </td>
          </tr>

        </table>
        <p style="font-style:italic">
          These settings control how the patterns are rendered below.  The page will automatically reload on a
          change to the settings.
        </p>

        <div id="pattern-template" style="display: none">
          <h3 class="pattern-name"></h3>
          <div  class="layout-row">
              <div>
                  <canvas class="pattern" width="256" height="256" data-pattern=""></canvas>
              </div>
              <div style="max-width: 580px"><div class="source" data-function=""></div></div>
          </div>
        </div>

        <h2>Example</h2>
        <p>Example of a complex pattern.</p>
        <div id="example"></div>
        

        <h2>Basic Patterns</h2>
        <div id="basic"></div>

        <h2>Variation Patterns</h2>
        <div id="variation"></div>

        <h2>Compound Patterns</h2>
        <div id="compound"></div>

        <h2>Complex Patterns</h2>
        <div id="complex"></div>

        <h2>Future Work</h2>
        <ul>
          <li>Add if statement support to LxLang</li>
          <li>Better stability in LxLang</li>
          <li>Indexing expressions in l-values for LxLang</li>
          <li>Parameterization of patterns</li>
          <li>Color patterns (gradients, etc.)</li>
        </ul>

        <script type="text/javascript">
        <!--

          var color0 = [ 0, 0, 0 ];
          var color1 = [ 255, 255, 255 ];
          
          function checkCookies()
          {
            var scheme = $.cookie('colorScheme');
            if (scheme)
            {
              $("#colorScheme").val(scheme);
              var arr = scheme.split('|');
              eval("color0 = " + arr[0] + ";");
              eval("color1 = " + arr[1] + ";");
            }
            var multisample = $.cookie('multisample');
            if (multisample)
              $("#multisample").val(multisample);
           
            var resolution = $.cookie('resolution');
            if (resolution)
              $("#resolution").val(resolution);
          }

          (function ($) {

              var util =
              {
                drawRow : function (ctx, y, func, multisample)
                {
                    var rowData = ctx.createImageData(this.width, 1);
                    var pixels = rowData.data;
                    for (var x = 0; x < this.width; ++x) {

                      var uv = [
                        (x / (this.width)),
                        (y / (this.height)),
                        0
                      ];
                      
                      var dx = (.5 / this.width);
                      var dy = (.5 / this.height);

                      var g;
                      if (multisample)
                      {
                        g = 2 * func(uv);
                        g += func([uv[0] - dx, uv[1] - dy, 0]);
                        g += func([uv[0] + dx, uv[1] - dy, 0]);
                        g += func([uv[0] + dx, uv[1] + dy, 0]);
                        g += func([uv[0] - dx, uv[1] + dy, 0]);
                        g += func([uv[0] - dx, uv[1], 0]);
                        g += func([uv[0] + dx, uv[1], 0]);
                        g += func([uv[0], uv[1] + dy, 0]);
                        g += func([uv[0], uv[1] + dy, 0]);
                        g /= 10;
                      }
                      else
                        g = func(uv);
                      
                      var c = [0, 0, 0];
                      if (g >= 0 && g <= 1) {
                        var gp = Math.max(Math.min(g, 1), 0);
                        for (var i = 0; i < 3; ++i)
                          c[i] = Math.floor(lx.core.blend(color0[i], color1[i], gp));
                      }
                      else if (g == NaN) {
                        c = [255, 0, 255];
                      }
                      else if (g === undefined) {
                        c = [255, 255, 0];
                      }
                      else if (g === Infinity || g === -Infinity) {
                        c = [0, 255, 255];
                      }
                      else {
                        c = [255, 0, 0];
                      }

                      pixels[x * 4 + 0] = c[0];
                      pixels[x * 4 + 1] = c[1];
                      pixels[x * 4 + 2] = c[2];
                      pixels[x * 4 + 3] = 255;
                    }
                    ctx.putImageData(rowData, 0, y);
                },
              };

              var methods =
              {

                draw : function(options)
                {
                  var _this = this;
                  var multisample = options.multisample;

                  var func = options.func;
                  var dataFunc = $(this).attr("data-pattern");
                  if (dataFunc)
                    eval("func = function(uv) { " + dataFunc + " };");

                  if (func)
                  {
                      var ctx = this.getContext('2d');
                      var tasks = [];
                      for (var y = 0; y < this.height; ++y) {
                        var task = (function(y) { return function() { util.drawRow.call(_this, ctx, y, func, multisample); } })(y); 
                        tasks.push(task);
                      }

                      tasks.push( function() { $(_this).seamlessImage({ sliderMax : 8, count : 5 }); } );

                      //
                      // run_tasks will loop through the array of functions using setTimeout so that
                      // it does not grab the focus entirely from the browser (i.e. the browse is
                      // still usable by the user).
                      //
                      lx.core.run_tasks(tasks, 0, { groupSize: 4 });
                  }
                },
              };


              $.fn.pattern = function (options) {

                options = $.extend({
                  multisample : true,
                }, options);
                
                return this.each(function () {
                  methods.draw.call(this, options);
                });
              };
            })(jQuery);

            function showPatterns(section, names)
            {
              $.each(names, function(i, value) {
                var div = $("#pattern-template").clone();
                div.attr("id", "");
                div.find(".pattern-name").text(value);
                div.find(".pattern").attr("data-pattern", "return lx.patterns." + value + "(uv);");
                div.find(".source").attr("data-function", "lx.patterns." + value);
                $(section).append(div);
                div.show();
              });
            }
            
            var lxlangSource;
            var lxlangSource2;
            function loadLxLang()
            {
                var parser2 = new lxlang2.Parser();
                var genJs = new lxlang2.GenerateJavascript();

                $.ajax("../shared/script/lx.patterns.lxlang" + "?rand=" + Math.random(), {
                    dataType : "text",
                    async : false,
                    success : function(text) {
                                                    
                        var ast = parser2.parse(text);
                        var code = genJs.translate(ast, { includeSource : true });
                        lxlangSource = code;
                        lxlangSource2 = genJs.translate(ast);
                        try {
                            eval(code);
                        } catch (e)
                        {
                            console.log(code);
                            console.log("Error in translated LxLang code");
                            throw e;
                        }
                    }
                });
            }

            function compileWithGoogleClosureCompiler(source)
            {
                var form = $("<form/>");
                form.attr("method", "post");
                form.attr("action", "http://closure-compiler.appspot.com/compile");
                form.attr("target", "_blank");

                var src = $("<input type='hidden' name='js_code' />");
                src.val( source );

                form.append( src );
                form.append( $("<input type='hidden' name='output_format' value='text'/>") );
                form.append( $("<input type='hidden' name='output_info' value='compiled_code'/>") );
                form.append( $("<input type='hidden' name='compilation_level' value='ADVANCED_OPTIMIZATIONS'/>") );

                $("body").append(form);
                form.submit();
            }

            $(document).ready(function () {
 
              loadLxLang();
              checkCookies();

              $("#colorScheme").change(function() {
                var scheme = $(this).val();
                $.cookie('colorScheme', scheme);
                window.location.reload(true);
              });
              $("#multisample").change(function() {
                $.cookie('multisample', $(this).val());
                window.location.reload(true);
              });
              $("#resolution").change(function() {
                $.cookie('resolution', $(this).val());
                window.location.reload(true);
              });

              var resolution = $("#resolution").val().split(",");
              var canvasWidth = parseInt(resolution[0]);
              var canvasHeight = parseInt(resolution[0]);
              $(".pattern").attr("width", canvasWidth).attr("height", canvasHeight);


              var dataUri = 'data:text/plain,' + escape(lxlangSource);
              $("#download-link").attr("href", dataUri).attr("target", "_blank");

              $("#compiled-link").click(function() {
                compileWithGoogleClosureCompiler(lxlangSource2);
                return false;
              });

              showPatterns("#example", [ "weave" ]);
              showPatterns("#basic", ["checker", "spot", "stripe", "tile", "diamond", "wave" ]);
              showPatterns("#variation", [ "star", "ribbon", "checkerSmooth", "gateLattice" ]);
              showPatterns("#compound", "circle,roundedTile,spotwave,spotdiamondxor,gridBump".split(","));
              showPatterns("#complex", [ "weave" ]);

              $("#toc").tableOfContents();

              var options = {};
              options.multisample = ($("#multisample").val() == "true");

              window.setTimeout(function() { $(".pattern").pattern(options); }, 500);
              $(".source").includeSource();

            });
        -->
        </script>

        <!-- Google Analytics -->         <script type="text/javascript">
            var _gaq = _gaq || [];
            _gaq.push(['_setAccount', 'UA-604613-10']);
            _gaq.push(['_trackPageview']);
            (function () {
                var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
            })();        </script> 

    </body>
</html>
