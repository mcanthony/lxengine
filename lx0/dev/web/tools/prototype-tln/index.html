<!DOCTYPE html>
<html>
    <head>
      <title>LxWeb Prototype</title>
      <link type="text/css" href="../shared/style/default.less" rel="stylesheet/less" />
      <link type="text/css" href="style.less" rel="stylesheet/less" />
      
      <script type="text/javascript" src="../shared/script/extern/less-1.1.3.min.js"></script>
      <script type="text/javascript" src="../shared/script/extern/jquery-1.6.4.min.js"></script>
    </head>
    <body>
       <div id="body-wrap1">
        <h1>LxWeb Prototype</h1>

        <h2>Gravity Tide: Neutron</h2>

        <div>
            <div id="div" style="width: 512px; height: 288px; border: 1px solid #333; box-shadow: 3px 3px 6px #EEE; padding: 0; margin: 0em auto 0em auto;">
            </div>
        </div>

        <h2>Controls</h2>
        <table class="clean-table">
            <tr><td>Numpad 4,6</td><td>move left, right</td></tr>
            <tr><td>W</td><td>fire primary weapon, normal rate</td></tr>
            <tr><td>E</td><td>fire primary weapon, burst rate (greater energy drain)</td></tr>
        </table>

        <h2>Todo</h2>
        <ul>
            <li>Energy bar HUD</li>
            <li>Score</li>
        </ul>


        <style>
        .menuHover
        {
          color : #C00;
          cursor:default;
        }
        </style>
        <div id="mainMenu" style="display:none;">
          <ul>
            <li id="mainMenu-new">New</li>
            <li id="mainMenu-load">Load</li>
            <li id="mainMenu-highScores">High Scores</li>
            <li id="mainMenu-exit">Exit</li>
          </ul>
        </div>


        <script type="text/javascript">
        <!--

        // Credit: http://stackoverflow.com/questions/4954403/can-jquery-keypress-detect-more-than-one-key-at-the-same-time
        (function($) {

            var data =
            {
                _ignore : 
                {
                    116 /*F5*/ : true,      // Allow web page refresh
                },

                keyState : { },
            };

            var methods =
            {
                

                init : function() {
                    var _this = this;
                    var state = data.keyState;
                    var ignore = data._ignore;
                    $(this).keydown(function(event) { state[event.which] = true; return ignore[event.which] !== undefined; });
                    $(this).keyup(function(event) { delete state[event.which]; return ignore[event.which] !== undefined; });
                    $(this).data('keyState', data);                
                },

                state : function() {                
                    var data = $(this).data('keyState');
                    return data.keyState;
                },
            };

            $.fn.keyState = function(method) {
                
                method = method || "init";

                var inner;
                var ret = this.each(function() {
                    inner = methods[method].apply(this, []);
                });
                return inner ? inner : ret;
            };

        })(jQuery);




        function importLibCore (NS) {
          
            NS.blend = function (a, b, t) {
                return a * (1 - t) + b * t;
            };

            NS.easeIn = function (x) { return Math.sin(x * Math.PI / 2); };
            NS.easeIn2 = function (x) { NS.easeIn(NS.easeIn(x)); };

            NS.each = function(x, f) { 
              for (var i in x) {
                f.call(x[i], i, x[i]);
              }
            };
        }

        var lib = { };
        importLibCore(lib);

        var engine = {};
        engine._state = null;
        engine._actionQueue = [];


        engine.setTimeout = function(code, delay) {
          return window.setTimeout(code, delay);
        };

        engine.changeState = function(state) {
          this._actionQueue.push(function() {
            this._state = state;
            this.gametime = 0;
            this._state.init(this._gametime);
          });
        };

        engine.run = function () {
            this.gametime = 0;
            var gametick = 20;

            this._state.init(this.gametime);
            
            var _this = this;
            (function gameLoop() {

                lib.each(_this._actionQueue, function() {
                  this.call(_this);
                });
                _this._actionQueue = [];

                _this._state.update(_this.gametime);
                _this._state.draw(_this.gametime);
                _this.gametime += gametick;
                _this.setTimeout(gameLoop, gametick);
            })();
        };


        var State = function(options) {
          $.extend(this, options);
        };
        $.extend(State.prototype, {
          init : function(gtime) {},
          update : function(gtime) {},
          draw : function(gtime) {},
          shutdown : function(gtime) {}
        });

        var Entity = function(options) {
          $.extend(this, options);
        };
        $.extend(Entity.prototype, {
          update : function(gtime) {},
          draw : function(ctx, gtime) { },
        });


        var StarField = function(width, height) 
        {
          this._width = width;
          this._height = height;
          this._stars = [];

          for (var i = 0; i < 64; ++i)
            this._stars.push(this._generateStar());
        };
        $.extend(StarField.prototype, Entity.prototype);
        $.extend(StarField.prototype, {

          _generateStar : function() {
              return {
                  x : Math.random() * this._width,
                  y : Math.random() * this._height, 
                  speed : Math.random() * 3 + .1,
                  color : Math.floor(32 + Math.random() * 127),
              };
          },

          init : function()
          {
            for (var i = 0; i < 128; ++i)
              this._stars.push(this._generateStar());
          },

          update : function(gtime) 
          {
            _starField = this;
            lib.each(this._stars, function() {
                this.y += this.speed;
                if (this.y > _starField._height)
                {
                  this.x = Math.random() * _starField._width;
                  this.y = 0;
                }
            });
          },

          draw : function(ctx, gtime)
          {
            lib.each(this._stars, function() {
              ctx.fillStyle = "rgb(" + this.color + "," + this.color + "," + this.color + ")";
              ctx.fillRect(this.x, this.y, 2, 2);
            });
          }

        });

        var Ship = function() 
        {
            this.width = 32;
            this.height = 32;
            this.x = 512/2 - this.width / 2;
            this.y = 288 - this.height / 2 - 16;

            this.lastFire = 0;
            this.energy = 1000;
            this.shields = 1000;

            this.score = 0;
        };
        $.extend(Ship.prototype, Entity.prototype);
        $.extend(Ship.prototype, {

          update : function(gtime) 
          {
            this.energy = Math.min(1000, this.energy + 4);
            this.shields = Math.min(1000, this.shields + .1);
          },

          draw : function(ctx, gtime)
          {
            ctx.fillStyle="blue";
            ctx.fillRect(this.x - this.width / 2, this.y - this.height / 2, this.width, this.height);
          }

        });

        var Missile = function(x, y)
        {
            this.x = x;
            this.y = y;
            this.width = 4;
            this.height = 8;
        };
        $.extend(Missile.prototype, Entity.prototype);
        $.extend(Missile.prototype, {
            update : function (gtime)
            {
                this.y -= 6;
                if (this.y < -this.height)
                    this.dead = true;
            },

            draw : function(ctx, gtime)
            {
                ctx.fillStyle = "yellow";
                ctx.fillRect(this.x - this.width / 2, this.y - this.height / 2, this.width, this.height);
            }
        });

        var Enemy = function()
        {
            this.width = 16;
            this.height = 24;
            this.x = 256 + 224 * (Math.random() - .5);
            this.y = -2000 * Math.random() - 288;
        };
        $.extend(Enemy.prototype, Entity.prototype);
        $.extend(Enemy.prototype, {
          
          collidable : true,

          update : function(gtime) 
          {
            this.y += 2;
          },

          draw : function(ctx, gtime)
          {
            ctx.fillStyle = "cyan";
            ctx.fillRect(this.x - this.width / 2, this.y - this.height / 2, this.width, this.height);
          }

        });

        function intersect(ship, enemy)
        {                    
            return Math.abs(ship.x - enemy.x) < (ship.width + enemy.width) / 2 
                && Math.abs(ship.y - enemy.y) < (ship.height + enemy.height) /2;
        }

        var HudEnergyBar = function(ship, property, offset, color, width)
        {
            this._ship = ship;
            this._prop = property;
            this._offset = offset;
            this._color = color;
            this._width = width;
            this._last = this._ship.energy;
        };
        $.extend(HudEnergyBar.prototype, Entity.prototype,
        {
            _value : function ()
            {
                return this._ship[this._prop];
            },

            update : function (ctx, gtime)
            {
            },

            draw : function (ctx, gtime)
            {
                ctx.strokeStyle = "#777";
                ctx.strokeRect(512 - this._offset, 288 - 108, this._width, 102);

                energy = lib.blend(this._value(), this._last, .8);
                energy /= 10;

                ctx.fillStyle = "#93413d";
                ctx.fillRect(513 - this._offset, 288 - 107, this._width - 2, 100 - energy);
                ctx.fillStyle = this._color;
                ctx.fillRect(513 - this._offset, 288 - 107 + (100 - energy), this._width - 2, energy);
                this._last = energy * 10;
            },            
        });

        var HudScore = function(ship)
        {
            this._ship = ship;
        };
        $.extend(HudScore.prototype, Entity.prototype,
        {
            update : function (ctx, gtime)
            {
            },

            draw : function (ctx, gtime)
            {
                ctx.font = "small-caps 32px Serif";
                ctx.textAlign = "right";
                ctx.fillStyle = "#f0f3d8";
                ctx.fillText(this._ship.score, 512 - 6, 36);
            },            
        });

        var physics =
        {
            update : function (ship, entities, missiles)
            {
                lib.each(entities, function() {
                    if (this.collidable)
                    {   
                        if (intersect(ship, this))
                        {
                            this.dead = true;
                            ship.shields -= 50;
                            ship.score += 10;
                        }
                    }
                });

                lib.each(missiles, function() {
                    var missile = this;
                    lib.each(entities, function() {
                        var enemy = this;
                        if (enemy.collidable) {                            
                            if (intersect(missile, enemy)) {
                                enemy.dead = true;
                                missile.dead = true;
                                ship.score += 10;
                            }
                        }
                    });
                });
            }
        };

        var levels =
        {
            1 : [ ],
        };

            
        function addWave(level, timeOffset, offsetX, options)
        {
            var options = $.extend({
                delay : 350,
                distance : 48,
            }, options);

            var time;
            for (var i = 0; i < 5; i ++)
            {
                var x = offsetX + options.distance * i;
                time = timeOffset + options.delay * i;
                level.push(["Enemy", time, x]);
            }
            return time;
        }

        var time = 0;
                
        time = addWave(levels[1], time + 1000, 128, { delay : 500 });
        time = addWave(levels[1], time + 1000, 196);
        time = addWave(levels[1], time + 1600, 32);
        time = addWave(levels[1], time + 1200, 128);
        time = addWave(levels[1], time + 200, 200);
        
        time = addWave(levels[1], time + 1700, 200);
        time = addWave(levels[1], time + 200, 150);
        time = addWave(levels[1], time + 200, 125);

        time += 3000;
        time = addWave(levels[1], time, 80, { delay : 0, distance : 64 } );
        time = addWave(levels[1], time + 600, 80 + 32, { delay : 0, distance : 64 } );
        time = addWave(levels[1], time + 600, 80 + 64, { delay : 0, distance : 64 } );

        time += 2500;
        time = addWave(levels[1], time, 80 + 64, { delay : 0, distance : 64 } );
        time = addWave(levels[1], time + 600, 80 + 96, { delay : 0, distance : 64 } );
        time = addWave(levels[1], time + 600, 80 + 128, { delay : 0, distance : 64 } );

        time = addWave(levels[1], time + 3000, 200, { delay : 200 } );
        time = addWave(levels[1], time + 200, 150, { delay : 200 } );
        time = addWave(levels[1], time + 200, 125, { delay : 200 } );

        function cleanList(list)
        {
            var clean = [];
            for (var i = 0; i < list.length; ++i)
                if (!list[i].dead)
                    clean.push(list[i]);
            return clean;
        }


        var stateStarfield = new State({
          _ctx : null,
          _width : 0,
          _height : 0,

          _entities : [],
          _missiles : [],

          init: function (gametime) {
              
              this._width = $("#div").width();
              this._height = $("#div").height();

              this._ship = new Ship();          
              this._entities.push(
                new StarField(this._width, this._height),
                this._ship,
                new HudEnergyBar(this._ship, "energy", 16, "#358e37", 6),
                new HudEnergyBar(this._ship, "shields", 32, "#4fe51b", 12),
                new HudScore(this._ship)
              );

              /*for (var i = 0; i < 32; ++i)
                this._entities.push(new Enemy());*/

              // Construct the GUI
              var gui = $("<canvas/>");
              gui.attr("width", this._width);
              gui.attr("height", this._height);
              $("#div").html( gui.show() );
             
              this._ctx = gui[0].getContext('2d');
            },

            update: function (gametime) {

              function firePrimary(state, ship, delay, energy)
              {
                if (gametime - ship.lastFire > delay && ship.energy >= energy)
                {
                    ship.energy -= energy;
                    var missile = new Missile(ship.x, ship.y - ship.height - 2);
                    state._missiles.push(missile);
                    state._entities.push(missile);
                    ship.lastFire = gametime;
                }
              }


              if (engine._keyState[100] /*numpad 4*/)
              {
                this._ship.x -= 2;
              }
              if (engine._keyState[102] /*numpad 6*/)
              {
                this._ship.x += 2;
              }
              if (engine._keyState[69] /*E*/)
              {
                firePrimary(this, this._ship, 50, 60);
              }
              if (engine._keyState[87] /*W*/)
              {
                firePrimary(this, this._ship, 120, 50);
              }

              
              (function () {
                while (levels[1].length > 0) 
                {
                    var next = levels[1][0];
                    if (next[1] <= gametime)
                    {
                        eval("var ent = new " + next[0] + "();");
                        ent.x = next[2];
                        ent.y = -ent.height;
                        this._entities.push(ent);
                        levels[1].shift();
                    }
                    else 
                        return;
                }
              }).call(this);

              
              lib.each(this._entities, function() {
                this.update(gametime);
              });
              physics.update(this._ship, this._entities, this._missiles);

              this._missiles = cleanList(this._missiles);
              this._entities = cleanList(this._entities);
            },

            draw: function (gametime) {
              var ctx = this._ctx;
              var width = this._width;
              var height = this._height;

              ctx.clearRect(0, 0, width, height);
              ctx.fillStyle = "black";
              ctx.fillRect(0, 0, width, height);

              lib.each(this._entities, function() {
                this.draw(ctx, gametime);
              });
            },
        });

        var state =
        {
            init: function (gametime) {
              
              // Construct the GUI
              var gui = $("#mainMenu").clone();
              gui.find("li").each(function() {
                $(this).hover(function() {
                  $(this).addClass("menuHover");
                },                 
                function() { 
                  $(this).removeClass("menuHover");                
                });
              });
              gui.find("#mainMenu-new").click(function() {
                engine.changeState(stateStarfield);
              });

              $("#div").html( gui.show() );
             
            },
            update: function (gametime) {
            },
            draw: function (gametime) {
            },
        };





        $(document).ready(function () {

            $(document).keyState();

            engine._state = state;
            engine._keyState = $(document).keyState('state');
            engine.run();
        });
        -->
        </script>

        <!-- Google Analytics -->         <script type="text/javascript">
            var _gaq = _gaq || [];
            _gaq.push(['_setAccount', 'UA-604613-10']);
            _gaq.push(['_trackPageview']);
            (function () {
                var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
            })();        </script> 

    </body>
</html>
